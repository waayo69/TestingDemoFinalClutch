@model TestingDemo.Models.ViewModels.PlanningDashboardViewModel
@using TestingDemo.Models
@using System.Linq

@{
    ViewData["Title"] = "Planning Dashboard";
}


<div class="container-fluid pt-2 pb-4">
    <!-- Header -->
    <div class="dashboard-header mb-4 p-4 rounded-4 shadow-sm bg-white border-0">
        <div class="row align-items-center g-3">
            <div class="col-12 col-lg-6">
                <div class="d-flex align-items-center">
                    <div class="header-icon-box bg-primary bg-opacity-10 text-primary p-3 rounded-3 me-3">
                        <i class="bi bi-clipboard-check fs-3"></i>
                    </div>
                    <div>
                        <h2 class="fw-bold mb-0 text-dark">@ViewData["Title"]</h2>
                        <p class="text-muted mb-0">Track project progress and plan requirements</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="d-flex flex-wrap justify-content-lg-end align-items-center gap-2">
                    <form asp-action="Index" method="get" class="search-group">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0 border-0 shadow-sm ps-3">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" name="searchString" value="@ViewData["CurrentFilter"]" 
                                   class="form-control border-start-0 border-0 shadow-sm ps-2 py-2 rounded-end" 
                                   placeholder="Search tracking #, name..." style="width: 250px;" />
                            @if (!String.IsNullOrEmpty(ViewData["CurrentFilter"] as string))
                            {
                                <a asp-action="Index" class="btn btn-light border-0 shadow-sm ms-2 rounded-circle" title="Clear search">
                                    <i class="bi bi-x-lg"></i>
                                </a>
                            }
                        </div>
                    </form>

                    <div class="dropdown">
                        <button class="btn btn-white shadow-sm border-0 px-3 py-2 dropdown-toggle d-flex align-items-center gap-2 rounded-3" 
                                type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-sort-down text-primary"></i>
                            <span class="fw-semibold">Sort</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg mt-2 p-2 rounded-3">
                            <li><a class="dropdown-item rounded-2" asp-action="Index" asp-route-sortOrder="" asp-route-searchString="@ViewData["CurrentFilter"]">Default</a></li>
                            <li><a class="dropdown-item rounded-2" asp-action="Index" asp-route-sortOrder="name_desc" asp-route-searchString="@ViewData["CurrentFilter"]">Name (Z-A)</a></li>
                            <li><a class="dropdown-item rounded-2" asp-action="Index" asp-route-sortOrder="Date" asp-route-searchString="@ViewData["CurrentFilter"]">Date (Oldest)</a></li>
                            <li><a class="dropdown-item rounded-2" asp-action="Index" asp-route-sortOrder="date_desc" asp-route-searchString="@ViewData["CurrentFilter"]">Date (Newest)</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null || TempData["ErrorMessage"] != null)
    {
        <div class="alert @(TempData["SuccessMessage"] != null ? "alert-success border-success" : "alert-danger border-danger") alert-dismissible fade show mb-4 shadow-sm border-0 border-start border-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi @(TempData["SuccessMessage"] != null ? "bi-check-circle-fill text-success" : "bi-exclamation-triangle-fill text-danger") fs-4 me-3"></i>
                <div>
                    <strong class="d-block mb-1">@(TempData["SuccessMessage"] != null ? "Success!" : "Action Required")</strong>
                    <span>@(TempData["SuccessMessage"] ?? TempData["ErrorMessage"])</span>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Tabbed Navigation -->
    <div class="dashboard-card border-0 shadow-sm rounded-4 bg-white overflow-hidden mb-5">
        <div class="card-header bg-white border-bottom-0 pt-4 px-4">
            <ul class="nav nav-pills custom-tabs mb-0" id="planningTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active fw-bold px-4 py-3" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-pane" type="button" role="tab">
                        <i class="bi bi-clock-history me-2"></i> Pending Clients
                        <span class="badge rounded-pill bg-warning bg-opacity-10 text-warning ms-2">@Model.PendingClients.TotalCount</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold px-4 py-3" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed-pane" type="button" role="tab">
                        <i class="bi bi-check2-all me-2"></i> Completed/Progressing
                        <span class="badge rounded-pill bg-success bg-opacity-10 text-success ms-2">@Model.CompletedClients.TotalCount</span>
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="tab-content" id="planningTabsContent">
            <!-- Pending Clients Pane -->
            <div class="tab-pane fade show active" id="pending-pane" role="tabpanel" aria-labelledby="pending-tab">
                <div class="p-0">
                    @if (Model.PendingClients.Any())
                    {
                        @await Html.PartialAsync("_PendingClientTable", Model.PendingClients)
                    }
                    else
                    {
                        <div class="empty-state text-center py-5">
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 100px; height: 100px;">
                                <i class="bi bi-folder2-open fs-1 text-muted"></i>
                            </div>
                            <h4 class="fw-bold">No clients found</h4>
                            <p class="text-muted mb-0">Clients for documentation will appear here.</p>
                        </div>
                    }
                    
                    @if (Model.PendingClients.TotalPages > 1)
                    {
                        <div class="pagination-container">
                            @await Html.PartialAsync("_Pagination", null, new ViewDataDictionary(ViewData) {
                                ["pageModel"] = Model.PendingClients,
                                ["pageAction"] = "Index",
                                ["pageNumberParam"] = "pendingPageNumber",
                                ["otherPageNumberParam"] = "completedPageNumber",
                                ["otherPageNumber"] = Model.CompletedClients.PageIndex
                            })
                        </div>
                    }
                </div>
            </div>

            <!-- Completed Clients Pane -->
            <div class="tab-pane fade" id="completed-pane" role="tabpanel" aria-labelledby="completed-tab">
                <div class="p-0">
                    @if (Model.CompletedClients.Any())
                    {
                        @await Html.PartialAsync("_PendingClientTable", Model.CompletedClients)
                    }
                    else
                    {
                        <div class="empty-state text-center py-5">
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 100px; height: 100px;">
                                <i class="bi bi-folder2-open fs-1 text-muted"></i>
                            </div>
                            <h4 class="fw-bold">No clients found</h4>
                            <p class="text-muted mb-0">Clients for documentation will appear here.</p>
                        </div>
                    }
                    
                    @if (Model.CompletedClients.TotalPages > 1)
                    {
                        <div class="pagination-container">
                            @await Html.PartialAsync("_Pagination", null, new ViewDataDictionary(ViewData) {
                                ["pageModel"] = Model.CompletedClients,
                                ["pageAction"] = "Index",
                                ["pageNumberParam"] = "completedPageNumber",
                                ["otherPageNumberParam"] = "pendingPageNumber",
                                ["otherPageNumber"] = Model.PendingClients.PageIndex
                            })
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Media Viewer Modal (Shared) -->
<div class="modal fade" id="mediaViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white border-0 py-3">
                <h5 class="modal-title fw-bold mb-0" id="mediaViewerModalLabel">
                    <i class="bi bi-file-earmark-medical me-2"></i>Proof Document
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 text-center bg-dark">
                <div id="mediaViewerContent" class="d-flex align-items-center justify-content-center" style="min-height: 200px;">
                    <img id="fullSizeImage" src="" alt="Proof" class="img-fluid" style="max-height: 80vh; object-fit: contain; display: none;" />
                    <iframe id="docViewer" src="" class="w-100" style="height: 80vh; border: none; display: none;"></iframe>
                </div>
            </div>
            <div class="modal-footer bg-light border-0 py-3">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4 py-2" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Close
                </button>
                <a id="downloadMediaLink" href="" download class="btn btn-primary rounded-pill px-4 py-2">
                    <i class="bi bi-download me-2"></i>Download
                </a>
            </div>
        </div>
    </div>
</div>

<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill me-2"></i>
                <span class="toast-message">Success</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Tab Persistence & Activation
            const activeTabId = localStorage.getItem('activePlanningTab');
            const urlParams = new URLSearchParams(window.location.search);
            
            let tabToActivate = null;
            
            if (urlParams.has('pendingPageNumber')) {
                tabToActivate = document.querySelector('#pending-tab');
            } else if (urlParams.has('completedPageNumber')) {
                tabToActivate = document.querySelector('#completed-tab');
            } else if (activeTabId) {
                tabToActivate = document.querySelector('#' + activeTabId);
            }
            
            if (tabToActivate) {
                bootstrap.Tab.getOrCreateInstance(tabToActivate).show();
            }
            
            // Log tab changes to storage
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(el => {
                el.addEventListener('shown.bs.tab', event => {
                    localStorage.setItem('activePlanningTab', event.target.id);
                });
            });

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Auto-dismiss alerts
            setTimeout(() => {
                document.querySelectorAll('.alert-dismissible').forEach(alert => {
                    bootstrap.Alert.getOrCreateInstance(alert).close();
                });
            }, 5000);

            // Re-open client modal if flagged
            var openClientId = '@(TempData["OpenClientId"] ?? "")';
            if (openClientId) {
                var modal = document.getElementById('clientModal-' + openClientId);
                if (modal) {
                    new bootstrap.Modal(modal).show();
                }
            }
        });

        // Resolve correct base URL
        var requirementsUrlBase = '@Url.Action("Requirements", "PlanningOfficer")/';

        // Requirement Management Functions
        function openAddRequirementModal(clientId) {
            var clientModal = bootstrap.Modal.getInstance(document.getElementById('clientModal-' + clientId));
            if (clientModal) clientModal.hide();
            setTimeout(() => {
                new bootstrap.Modal(document.getElementById('addReqModal-' + clientId)).show();
            }, 300);
        }

        function openEditRequirementModal(requirementId, clientId) {
            document.querySelectorAll('.modal.show').forEach(m => {
                var instance = bootstrap.Modal.getInstance(m);
                if (instance) instance.hide();
            });
            setTimeout(() => {
                var modal = document.getElementById('editRequirementModal-' + requirementId);
                if (modal) {
                    modal.setAttribute('data-client-id', clientId);
                    new bootstrap.Modal(modal).show();
                }
            }, 300);
        }

        function handleAddRequirementSubmit(clientId) {
            var form = document.getElementById('addRequirementForm-' + clientId);
            var submitBtn = document.getElementById('submitBtn-' + clientId);
            var successMsg = document.getElementById('successMessage-' + clientId);
            var fields = document.getElementById('formFields-' + clientId);

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Adding...';

            fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.ok ? res.text() : Promise.reject())
            .then(() => {
                fields.style.display = 'none';
                successMsg.style.display = 'block';
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Added!';
                submitBtn.className = 'btn btn-success rounded-pill px-4';
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('addReqModal-' + clientId)).hide();
                    refreshRequirementsList(clientId);
                }, 2000);
            })
            .catch(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Error! Try again';
            });
        }

        function handleEditRequirementSubmit(requirementId) {
            var form = document.getElementById('editRequirementForm-' + requirementId);
            var submitBtn = form.querySelector('button[type="submit"]');
            var clientId = form.closest('.modal').getAttribute('data-client-id');

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';

            fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.ok ? res.text() : Promise.reject())
            .then(() => {
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Saved!';
                submitBtn.className = 'btn btn-success rounded-pill px-4';
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('editRequirementModal-' + requirementId)).hide();
                    if (clientId) refreshRequirementsList(clientId);
                }, 1500);
            })
            .catch(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Error! Try again';
            });
        }

        function refreshRequirementsList(clientId) {
            var target = document.getElementById('req-list-' + clientId);
            if (!target) return;
            fetch(requirementsUrlBase + clientId + '?t=' + Date.now(), {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.ok ? res.text() : Promise.reject())
            .then(html => target.innerHTML = html)
            .catch(e => console.error("Refresh failed", e));
        }

        function deleteRequirement(id, clientId) {
            if (!confirm('Delete this requirement?')) return;
            var formData = new FormData();
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
            fetch('@Url.Action("DeleteRequirement", "PlanningOfficer")/' + id, {
                method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.ok ? (refreshRequirementsList(clientId), showToast('Deleted!')) : alert('Delete failed'));
        }

        function deletePhotoFromList(photoId, clientId) {
            if (!confirm('Delete this photo?')) return;
            var formData = new FormData();
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
            fetch('@Url.Action("DeleteRequirementPhoto", "PlanningOfficer")/' + photoId, {
                method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(data => data.success ? (refreshRequirementsList(clientId), showToast('Photo deleted!')) : alert(data.message));
        }

        function showToast(msg) {
            var t = document.getElementById('successToast');
            t.querySelector('.toast-message').textContent = msg;
            bootstrap.Toast.getOrCreateInstance(t).show();
        }

        function viewFullImage(src, name, type = 'image') {
            var m = document.getElementById('mediaViewerModal');
            document.getElementById('mediaViewerModalLabel').innerHTML = `<i class="bi bi-${type === 'image' ? 'image' : 'file-earmark-text'} me-2"></i>Proof: ${name}`;
            
            var img = document.getElementById('fullSizeImage');
            var doc = document.getElementById('docViewer');
            var link = document.getElementById('downloadMediaLink');
            
            if (type === 'image') {
                img.src = src;
                img.style.display = 'block';
                doc.style.display = 'none';
            } else {
                doc.src = src;
                doc.style.display = 'block';
                img.style.display = 'none';
            }
            
            link.href = src;
            new bootstrap.Modal(m).show();
        }

        // Lazy load requirements on modal show
        document.addEventListener('shown.bs.modal', function (event) {
            var modal = event.target;
            if (modal?.id?.startsWith('clientModal-')) {
                var clientId = modal.id.replace('clientModal-', '');
                refreshRequirementsList(clientId);
            }
            
            // Populate assigned Customer Care user dropdown
            if (modal?.id?.startsWith('proceedToLiaisonModal-')) {
                var select = modal.querySelector('.assign-cc-select');
                if (select && select.options.length <= 1) { // Only fetch if not already loaded
                    fetch('@Url.Action("GetCustomerCareUsers", "PlanningOfficer")')
                        .then(r => r.json())
                        .then(users => {
                            users.forEach(u => {
                                var opt = document.createElement('option');
                                opt.value = u.id;
                                opt.textContent = u.name;
                                select.appendChild(opt);
                            });
                        })
                        .catch(err => console.error('Failed to load CC users', err));
                }
            }
        });

        // SignalR auto-reload
        if (window.connection) {
            connection.on("ReceiveUpdate", () => location.reload());
        }
    </script>
}