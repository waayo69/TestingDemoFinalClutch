@model TestingDemo.Models.ClientModel
@using TestingDemo.Models

@{
    var requirementsByClient = ViewBag.Requirements as System.Collections.Generic.Dictionary<int,
    System.Collections.Generic.List<TestingDemo.Models.PermitRequirementModel>>;
    var reqs = (requirementsByClient != null && requirementsByClient.ContainsKey(Model.Id)) ? requirementsByClient[Model.Id]
    : new System.Collections.Generic.List<TestingDemo.Models.PermitRequirementModel>();

    var typeBadgeClass = Model.TypeOfProject switch
    {
        "Retainership - BIR" => "bg-danger",
        "Retainership - SPP" => "bg-info text-dark",
        "One Time Transaction" => "bg-secondary",
        "External Audit" => "bg-dark",
        _ => "bg-light text-dark"
    };
}

<!-- Main Client Details Modal -->
<div class="modal fade" id="clientModal-@Model.Id" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white border-0 py-3">
                <h5 class="modal-title d-flex flex-wrap align-items-center gap-3 mb-0">
                    <i class="bi bi-person-vcard fs-4"></i>
                    <span class="fw-bold">@Model.ClientName</span>
                    <span class="badge rounded-pill @typeBadgeClass fs-6">@Model.TypeOfProject</span>
                    <span
                        class="badge @(Model.Status == "Planning" ? "bg-info" : "bg-secondary") rounded-pill fs-6">@Model.Status</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Client Information Section -->
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
                                style="width: 40px; height: 40px;">
                                <i class="bi bi-info-circle text-primary fs-5"></i>
                            </div>
                            <h6 class="fw-bold mb-0 text-primary">Client Information</h6>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="bg-light rounded-3 p-3 h-100 border-start border-4 border-primary">
                            <small class="text-muted d-block mb-2 fw-medium">Tracking Number</small>
                            <span class="text-monospace fw-bold fs-6 text-dark">@Model.TrackingNumber</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="bg-light rounded-3 p-3 h-100 border-start border-4 border-success">
                            <small class="text-muted d-block mb-2 fw-medium">Submitted Date</small>
                            <span class="fw-bold fs-6 text-dark">@Model.CreatedDate.ToString("yyyy-MM-dd")</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="bg-light rounded-3 p-3 h-100 border-start border-4 border-info">
                            <small class="text-muted d-block mb-2 fw-medium">Contact Number</small>
                            <span class="fw-bold fs-6 text-dark">@Model.ContactPersonNumber</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="bg-light rounded-3 p-3 h-100 border-start border-4 border-warning">
                            <small class="text-muted d-block mb-2 fw-medium">Email</small>
                            <span class="fw-bold fs-6 text-dark">@Model.Email</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="bg-light rounded-3 p-3 h-100 border-start border-4 border-danger">
                            <small class="text-muted d-block mb-2 fw-medium">Urgency Level</small>
                            <span
                                class="badge @(Model.UrgencyLevel == "Urgent" ? "bg-danger" : Model.UrgencyLevel == "Slightly Urgent" ? "bg-warning text-dark" : "bg-success") fs-6 rounded-pill">@Model.UrgencyLevel</span>
                        </div>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(Model.RegisteredCompanyAddress))
                    {
                        <div class="col-12">
                            <div class="bg-light rounded-3 p-3 border-start border-4 border-secondary">
                                <small class="text-muted d-block mb-2 fw-medium">Company Address</small>
                                <span class="fw-bold fs-6 text-dark">@Model.RegisteredCompanyAddress</span>
                            </div>
                        </div>
                    }
                </div>

                <!-- Return Note Section -->
                @if (!string.IsNullOrWhiteSpace(Model.PlanningReturnNote))
                {
                    <div class="alert alert-warning border-0 rounded-3 py-3 mb-4 bg-warning bg-opacity-10">
                        <div class="d-flex align-items-center">
                            <div class="bg-warning bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center me-3"
                                style="width: 32px; height: 32px;">
                                <i class="bi bi-info-circle text-warning"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading fw-bold mb-1 text-warning">Return Note</h6>
                                <p class="mb-0 text-dark">@Model.PlanningReturnNote</p>
                            </div>
                        </div>
                    </div>
                }

                <hr class="my-4 opacity-25" />

                <!-- Requirements Section -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
                            style="width: 40px; height: 40px;">
                            <i class="bi bi-list-check text-success fs-5"></i>
                        </div>
                        <h6 class="fw-bold mb-0 text-success">Permit Requirements</h6>
                    </div>
                    <button type="button" class="btn btn-primary rounded-pill px-3 py-2 shadow-sm"
                        onclick="openAddRequirementModal(@Model.Id)">
                        <i class="bi bi-plus-lg me-2"></i> Add Requirement
                    </button>
                </div>
                <div class="bg-light rounded-3 p-4 border" id="req-list-@Model.Id">
                    <div class="text-center py-4">
                        <div class="bg-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3"
                            style="width: 60px; height: 60px;">
                            <i class="bi bi-hourglass-split text-muted fs-3"></i>
                        </div>
                        <div class="text-muted fw-medium">Loading requirements...</div>
                    </div>
                </div>

                <hr class="my-4 opacity-25" />

                <!-- Project Details Section -->
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
                        style="width: 40px; height: 40px;">
                        <i class="bi bi-card-list text-info fs-5"></i>
                    </div>
                    <h6 class="fw-bold mb-0 text-info">Project Details</h6>
                </div>
                <div class="bg-light rounded-3 p-4 border" style="max-height: 400px; overflow-y: auto;">
                    @if (Model.TypeOfProject == "Retainership - BIR" && Model.RetainershipBIR != null)
                    {
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Type Of Registrant</small>
                                <div class="fw-bold">@Model.RetainershipBIR.TypeOfRegistrant</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <small class="text-muted">OCN Notes</small>
                                <div class="fw-bold">@Model.RetainershipBIR.OCNNotes</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Date OCN Generated</small>
                                <div class="fw-bold">@Model.RetainershipBIR.DateOCNGenerated?.ToString("yyyy-MM-dd")</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Date BIR Registration</small>
                                <div class="fw-bold">@Model.RetainershipBIR.DateBIRRegistration?.ToString("yyyy-MM-dd")
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <small class="text-muted">BIR RDO No.</small>
                                <div class="fw-bold">@Model.RetainershipBIR.BIRRdoNo</div>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(Model.RetainershipBIR.OtherBirRdoNo))
                            {
                                <div class="col-12 col-md-6">
                                    <small class="text-muted">Other BIR RDO No.</small>
                                    <div class="fw-bold">@Model.RetainershipBIR.OtherBirRdoNo</div>
                                </div>
                            }
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Tax Filing Status</small>
                                <div class="fw-bold">@Model.RetainershipBIR.TaxFilingStatus</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Need Catch-Up Accounting</small>
                                <div class="fw-bold">@Model.RetainershipBIR.NeedCatchUpAccounting</div>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(Model.RetainershipBIR.CatchUpReasons))
                            {
                                <div class="col-12">
                                    <small class="text-muted">Catch-Up Reasons</small>
                                    <div class="fw-bold">@Model.RetainershipBIR.CatchUpReasons</div>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.RetainershipBIR.OtherCatchUpReason))
                            {
                                <div class="col-12">
                                    <small class="text-muted">Other Catch-Up Reason</small>
                                    <div class="fw-bold">@Model.RetainershipBIR.OtherCatchUpReason</div>
                                </div>
                            }
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Catch-Up Start Date</small>
                                <div class="fw-bold">@Model.RetainershipBIR.CatchUpStartDate?.ToString("yyyy-MM-dd")</div>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(Model.RetainershipBIR.BIRComplianceActivities))
                            {
                                <div class="col-12">
                                    <small class="text-muted">BIR Compliance Activities</small>
                                    <div class="fw-bold">@Model.RetainershipBIR.BIRComplianceActivities</div>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.RetainershipBIR.OtherBIRCompliance))
                            {
                                <div class="col-12">
                                    <small class="text-muted">Other BIR Compliance</small>
                                    <div class="fw-bold">@Model.RetainershipBIR.OtherBIRCompliance</div>
                                </div>
                            }
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Retainership Start Date</small>
                                <div class="fw-bold">@Model.RetainershipBIR.BIRRetainershipStartDate?.ToString("yyyy-MM-dd")
                                </div>
                            </div>
                        </div>
                    }
                    else if (Model.TypeOfProject == "Retainership - SPP" && Model.RetainershipSPP != null)
                    {
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <small class="text-muted">SSS Reg No.</small>
                                <div class="fw-bold">@Model.RetainershipSPP.SSSCompanyRegNo</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <small class="text-muted">SSS Reg Date</small>
                                <div class="fw-bold">@Model.RetainershipSPP.SSSRegistrationDate?.ToString("yyyy-MM-dd")
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <small class="text-muted">PHIC Reg No.</small>
                                <div class="fw-bold">@Model.RetainershipSPP.PHICCompanyRegNo</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <small class="text-muted">PHIC Reg Date</small>
                                <div class="fw-bold">@Model.RetainershipSPP.PHICRegistrationDate?.ToString("yyyy-MM-dd")
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <small class="text-muted">HDMF Reg No.</small>
                                <div class="fw-bold">@Model.RetainershipSPP.HDMFCompanyRegNo</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <small class="text-muted">HDMF Reg Date</small>
                                <div class="fw-bold">@Model.RetainershipSPP.HDMFRegistrationDate?.ToString("yyyy-MM-dd")
                                </div>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(Model.RetainershipSPP.SPPComplianceActivities))
                            {
                                <div class="col-12">
                                    <small class="text-muted">SPP Compliance Activities</small>
                                    <div class="fw-bold">@Model.RetainershipSPP.SPPComplianceActivities</div>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.RetainershipSPP.OtherSPPCompliance))
                            {
                                <div class="col-12">
                                    <small class="text-muted">Other SPP Compliance</small>
                                    <div class="fw-bold">@Model.RetainershipSPP.OtherSPPCompliance</div>
                                </div>
                            }
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Retainership Start Date</small>
                                <div class="fw-bold">@Model.RetainershipSPP.SPPRetainershipStartDate?.ToString("yyyy-MM-dd")
                                </div>
                            </div>
                        </div>
                    }
                    else if (Model.TypeOfProject == "One Time Transaction" && Model.OneTimeTransaction != null)
                    {
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Registrant Type</small>
                                <div class="fw-bold">@Model.OneTimeTransaction.TypeOfRegistrant</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Area of Services</small>
                                <div class="fw-bold">@Model.OneTimeTransaction.AreaOfServices</div>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(Model.OneTimeTransaction.OtherAreaOfServices))
                            {
                                <div class="col-12">
                                    <small class="text-muted">Other Area</small>
                                    <div class="fw-bold">@Model.OneTimeTransaction.OtherAreaOfServices</div>
                                </div>
                            }
                        </div>
                    }
                    else if (Model.TypeOfProject == "External Audit" && Model.ExternalAudit != null)
                    {
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Audit Status</small>
                                <div class="fw-bold">@Model.ExternalAudit.ExternalAuditStatus</div>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(Model.ExternalAudit.ExternalAuditPurposes))
                            {
                                <div class="col-12">
                                    <small class="text-muted">Purposes</small>
                                    <div class="fw-bold">@Model.ExternalAudit.ExternalAuditPurposes</div>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.ExternalAudit.ExternalAuditOtherPurpose))
                            {
                                <div class="col-12">
                                    <small class="text-muted">Other Purpose</small>
                                    <div class="fw-bold">@Model.ExternalAudit.ExternalAuditOtherPurpose</div>
                                </div>
                            }
                            <div class="col-12 col-md-6">
                                <small class="text-muted">Report Date</small>
                                <div class="fw-bold">@Model.ExternalAudit.ExternalAuditReportDate?.ToString("yyyy-MM-dd")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer bg-light">
                <form asp-action="BackToFinance" asp-route-id="@Model.Id" method="post" class="d-inline">
                    <div class="input-group">
                        <input type="text" name="note" class="form-control" placeholder="Reason for return to Finance..." required style="max-width: 300px;">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-arrow-left-circle me-1"></i>Return to Finance
                        </button>
                    </div>
                </form>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Requirement Modal -->
<div class="modal fade" id="addReqModal-@Model.Id" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white border-0 py-3">
                <h5 class="modal-title fw-bold mb-0">
                    <i class="bi bi-plus-circle me-2"></i>Add Requirement
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form id="addRequirementForm-@Model.Id" asp-action="AddRequirement" method="post"
                onsubmit="handleAddRequirementSubmit(@Model.Id); return false;">
                @Html.AntiForgeryToken()
                <div class="modal-body p-4">
                    <input type="hidden" name="ClientId" value="@Model.Id" />
                    <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />

                    <!-- Success Message (initially hidden) -->
                    <div id="successMessage-@Model.Id"
                        class="alert alert-success border-0 rounded-3 bg-success bg-opacity-10 mb-4"
                        style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="bg-success bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center me-3"
                                style="width: 32px; height: 32px;">
                                <i class="bi bi-check-circle-fill text-success"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading fw-bold mb-1 text-success">Requirement Added Successfully!</h6>
                                <p class="mb-0 text-dark">The new requirement has been added to the client's list.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Form Fields -->
                    <div id="formFields-@Model.Id">
                        <div class="mb-3">
                            <label class="form-label fw-medium">
                                <i class="bi bi-card-text me-2 text-primary"></i>Requirement Name <span
                                    class="text-danger">*</span>
                            </label>
                            <textarea name="RequirementName" class="form-control rounded-3" rows="3"
                                placeholder="Enter the requirement name..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-medium">
                                <i class="bi bi-chat-left-text me-2 text-primary"></i>Description <span
                                    class="text-danger">*</span>
                            </label>
                            <textarea name="Description" class="form-control rounded-3" rows="3"
                                placeholder="Provide detailed description..." required></textarea>
                        </div>
                        <input type="hidden" name="IsRequired" value="true">
                    </div>
                </div>
                <div class="modal-footer border-0 py-3">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4 py-2"
                        data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 py-2 shadow-sm"
                        id="submitBtn-@Model.Id">
                        <i class="bi bi-plus-lg me-2"></i>Add Requirement
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
